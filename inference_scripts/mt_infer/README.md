# Inference script examples for multi-task learning
This folder provides example yaml configurations for multi-task learning tasks. The configurations include:

  * ``ml_lp_no_prediction.yaml`` defines a multi-task learning task with 2 self-supervised tasks: i/ a link prediction task on ``(user, rating, movie)`` edges, and ii/ a node feature reconstruction task on the ``title`` feature of ``movie`` nodes. There is no prediction task defined. It uses a single-layer RGCN model as its graph encoder.

  * ``ml_nc_ec_er_lp_only_infer.yaml`` defines a multi-task learning task with 6 tasks: i/ a node classification on the ``movie`` nodes with the label field as ``label``, ii/ a node classification on the ``movie`` nodes with the label field as ``label2``, iii/ an edge classification task on the ``(user, rating, movie)`` edges with the label field as ``rate_class``, iv/ an edge regression task on the ``(user, rating, movie)`` edges with the label field as ``rate``, v/ a link prediction task on the ``(user, rating, movie)`` edges, and vi/ a node feature reconstruction task on the ``title`` feature of ``movie`` nodes. These tasks are not associated with specific train/validation/test masks. It uses a single-layer RGCN model as its graph encoder.

  * ``ml_nc_ec_er_lp_with_mask_infer.yaml`` defines a multi-task learning task with 6 tasks: i/ a node classification on the ``movie`` nodes with the label field as ``label``, ii/ a node classification on the ``movie`` nodes with the label field as ``label2``, iii/ an edge classification task on the ``(user, rating, movie)`` edges with the label field as ``rate_class``, iv/ an edge regression task on the ``(user, rating, movie)`` edges with the label field as ``rate``, v/ a link prediction task on the ``(user, rating, movie)`` edges, and vi/ a node feature reconstruction task on the ``title`` feature of ``movie`` nodes. The tasks are associated with specific train/validation/test masks. It uses a single-layer RGCN model as its graph encoder.

  * ``ml_nc_lp_norm_with_mask_infer.yaml`` defines a multi-task learning task with 2 tasks: i/ a node classification on the ``movie`` nodes with the label field as ``label``, ii/ a link prediction task on ``(user, rating, movie)`` edges. It uses a single-layer RGCN model as its graph encoder. The output embedding of the second task will be normalized as it is using contrastive loss.

You can find the corresponding training configurations in ``training_scripts/gsgnn_mt/README``.

The following example script shows how to launch a GraphStorm multi-task inference task.
You may need to change the arguments according to your tasks.
For more detials please refer to https://graphstorm.readthedocs.io/en/latest/cli/model-training-inference/index.html.

```
python3 -m graphstorm.run.gs_multi_task_learning \
    --inference \
    --workspace graphstorm/inference_scripts/mt_infer \
    --num-trainers 4 \
    --num-servers 1 \
    --num-samplers 0 \
    --part-config /data/movielen_100k_multi_task_train_val_1p_4t/movie-lens-100k.json  \
    --ip-config ip_list.txt \
    --ssh-port 2222 \
    --cf ml_nc_ec_er_lp_with_mask_infer.yaml \
    --restore-model-path /data/gsgnn_mt/epoch-2/ \
    --save-prediction-path /data/gsgnn_mt/prediction/
```

The script loads a paritioned graph from ``/data/movielen_100k_multi_task_train_val_1p_4t/movie-lens-100k.json``
and a pre-trained model from ``/data/gsgnn_mt/epoch-2/`` to do multi-task inference.
The script loads all the inference task specific configurations from ``ml_nc_ec_er_lp_with_mask_infer.yaml``.
The prediction results are saved in ``/data/gsgnn_mt/prediction/``.

Note: All example movielens graph data are generated by ``tests/end2end-tests/create_data.sh``.
