# Graphstorm CI - All tests executed sequentially

name: continuous-integration

on:
  push:
    branches:
      - main
      - ci_dev
  # pull_request:
    

permissions:
  id-token: write
  contents: read

defaults:
  run:
    shell: bash

jobs:

  lint_check:
    runs-on: ubuntu-latest
    steps:
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: arn:aws:iam::698571788627:role/github-oidc-role
        aws-region: us-east-1
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Set up Python 3.x
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    - name: Install dependencies
      shell: bash
      run: |
        python -m pip install --upgrade pip
        python3 -m pip install pytest
        pip install boto3
    - name: Submit Job (for Push)
      if: ${{ github.event_name == 'push' }}
      shell: bash
      run: |
        echo "Start submitting job - Push"
        python3 ./submitJob.py --job-type CI-CPU-PUSH --name Graphstorm-LintCheck-Push-'${{ github.ref }}' --command FORCE_CUDA=1 python3 -m pip install -e '.[test]'  --no-build-isolation && python3 -m pip install pytest && sh ./tests/unit-tests/prepare_test_data.sh && export NCCL_IB_DISABLE=1; export NCCL_SHM_DISABLE=1; NCCL_NET=Socket NCCL_DEBUG=INFO && python3 -m pytest ./tests/unit-tests -s --wait
        python3 ./submitJob.py --job-type CI-CPU-PUSH --name Graphstorm-UnitTest-Push-'${{ github.ref }}' --command python3 -m pip install --upgrade prospector pip && FORCE_CUDA=1 python3 -m pip install -e '.[test]'  --no-build-isolation && pylint --rcfile=./tests/lint/pylintrc ./python/graphstorm/data/*.py && pylint --rcfile=./tests/lint/pylintrc ./python/graphstorm/dataloading/ && pylint --rcfile=./tests/lint/pylintrc ./python/graphstorm/config/ && pylint --rcfile=./tests/lint/pylintrc ./python/graphstorm/eval/ && pylint --rcfile=./tests/lint/pylintrc ./python/graphstorm/model/ && pylint --rcfile=./tests/lint/pylintrc ./python/graphstorm/trainer/ && pylint --rcfile=./tests/lint/pylintrc ./python/graphstorm/inference/ && pylint --rcfile=./tests/lint/pylintrc ./python/graphstorm/tracker/ && pylint --rcfile=./tests/lint/pylintrc ./python/graphstorm/utils.py && pylint --rcfile=./tests/lint/pylintrc ./sagemaker/launch_train.py && pylint --rcfile=./tests/lint/pylintrc ./sagemaker/scripts/*.py --wait
        python3 ./submitJob.py --job-type CI-CPU-PUSH --name Graphstorm-E2E-Push-'${{ github.ref }}' --command sh ./tests/end2end-tests/setup.sh && sh ./tests/end2end-tests/create_data.sh && sh ./tests/end2end-tests/tools/test_mem_est.sh && sh ./tests/end2end-tests/custom-gnn/run_test.sh && sh ./tests/end2end-tests/graphstorm-nc/test.sh && sh ./tests/end2end-tests/graphstorm-lp/test.sh && sh ./tests/end2end-tests/graphstorm-ec/test.sh && sh ./tests/end2end-tests/graphstorm-er/test.sh --wait
        python3 ./submitJob.py --job-type CI-CPU-PUSH --name Graphstorm-MultiE2E-Push-'${{ github.ref }}' --command sh ./tests/end2end-tests/setup.sh && sh ./tests/end2end-tests/create_data.sh && sh ./tests/end2end-tests/graphstorm-lp/mgpu_test.sh && sh ./tests/end2end-tests/graphstorm-nc/mgpu_test.sh && sh ./tests/end2end-tests/graphstorm-ec/mgpu_test.sh --wait

    # - name: Submit Job (for Pull Request)
    #   if: ${{ github.event_name == 'pull_request' }}
    #   shell: bash
    #   run: |
    #     echo "Start submitting job - Pull Request"
    #     python3 ./submitJob.py --job-type CI-CPU --name Graphstorm-LintCheck-PR#-'${{ github.event.number }}' --command "FORCE_CUDA=1 python3 -m pip install -e '.[test]'  --no-build-isolation && python3 -m pip install pytest && sh ./tests/unit-tests/prepare_test_data.sh && export NCCL_IB_DISABLE=1; export NCCL_SHM_DISABLE=1; NCCL_NET=Socket NCCL_DEBUG=INFO python3 -m pytest ./tests/unit-tests -s" --wait    
#put lintcheck COMMAND here
  # lint_check:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - name: Checkout repository
  #     uses: actions/checkout@v3
  #   - name: Check if changes beside docs
  #     uses: dorny/paths-filter@v2
  #     id: changes
  #     with:
  #       filters: |
  #         other_than_docs:
  #           - '!(docs/**)**'
  #   - name: Lint Check on AWS Batch
  #     if: steps.changes.outputs.other_than_docs == 'true'
  #     uses: ./.github/actions/
  #     with:
  #       job-type: CI-CPU
  #       job-name: Graphstorm-LintCheck
  #       command: FORCE_CUDA=1 python3 -m pip install -e '.[test]'  --no-build-isolation && python3 -m pip install pytest && sh ./tests/unit-tests/prepare_test_data.sh && export NCCL_IB_DISABLE=1; export NCCL_SHM_DISABLE=1; NCCL_NET=Socket NCCL_DEBUG=INFO python3 -m pytest ./tests/unit-tests -s

# put pytest COMMAND here
  # pytest:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - name: Checkout repository
  #     uses: actions/checkout@v3
  #   - name: Check if changes beside docs
  #     uses: dorny/paths-filter@v2
  #     id: changes
  #     with:
  #       filters: |
  #         other_than_docs:
  #           - '!(docs/**)**'
  #   - name: Pytest on AWS Batch
  #     if: steps.changes.outputs.other_than_docs == 'true'
  #     uses: ./.github/actions

    


