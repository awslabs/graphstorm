# Graphstorm CI - All tests executed conditional & sequentially
name: continuous-integration

on:
  push:
    branches:
      - main
      - ci_dev
  # pull_request_target:
    

permissions:
  id-token: write
  contents: read

defaults:
  run:
    shell: bash

env:
  COMMAND-PYTEST: chmod +x ./pytest_check.sh && ./pytest_check.sh
  COMMAND-LINT: chmod +x ./lint_check.sh && ./lint_check.sh
  COMMAND-E2E: chmod +x ./e2e_check.sh && ./e2e_check.sh
  COMMAND-E2E-MGPU: chmod +x ./e2e_mgpu_check.sh && ./e2e_mgpu_check.sh

jobs:

  lint_check:
    runs-on: ubuntu-latest
    steps:
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: arn:aws:iam::698571788627:role/github-oidc-role
        aws-region: us-east-1
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Set up Python 3.x
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    - name: Install dependencies
      shell: bash
      run: |
        python -m pip install --upgrade pip
        python3 -m pip install pytest
        pip install boto3
    - name: Submit Job (for Push)
      if: ${{ github.event_name == 'push' }}
      shell: bash
      run: |
        echo "Start submitting job - Push"  
        python3 ./submitJob.py --job-type CI-LINT-PUSH --name Graphstorm-LintTest-Push-'${{ github.ref }}' --command "${{ env.COMMAND-LINT }}" --wait

  pytest_check:
    needs: lint_check
    runs-on: ubuntu-latest
    steps:
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: arn:aws:iam::698571788627:role/github-oidc-role
        aws-region: us-east-1
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Set up Python 3.x
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    - name: Install dependencies
      shell: bash
      run: |
        python -m pip install --upgrade pip
        python3 -m pip install pytest
        pip install boto3
    - name: Submit Job (for Push)
      if: ${{ github.event_name == 'push' }}
      shell: bash
      run: |
        echo "Start submitting job - Push"  
        python3 ./submitJob.py --job-type CI-CPU-PUSH --name Graphstorm-PyTest-Push-'${{ github.ref }}' --command "${{ env.COMMAND-PYTEST }}" --wait

  e2e_check:
    needs: [pytest_check, lint_check]
    runs-on: ubuntu-latest
    steps:
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: arn:aws:iam::698571788627:role/github-oidc-role
        aws-region: us-east-1
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Set up Python 3.x
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    - name: Install dependencies
      shell: bash
      run: |
        python -m pip install --upgrade pip
        python3 -m pip install pytest
        pip install boto3
    - name: Submit Job (for Push)
      if: ${{ github.event_name == 'push' }}
      shell: bash
      run: |
        echo "Start submitting job - Push"  
        python3 ./submitJob.py --job-type CI-CPU-PUSH --name Graphstorm-E2ETest-Push-'${{ github.ref }}' --command "${{ env.COMMAND-E2E }}" --wait

  e2e_mgpu_check:
    needs: [pytest_check, lint_check]
    runs-on: ubuntu-latest
    steps:
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: arn:aws:iam::698571788627:role/github-oidc-role
        aws-region: us-east-1
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Set up Python 3.x
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    - name: Install dependencies
      shell: bash
      run: |
        python -m pip install --upgrade pip
        python3 -m pip install pytest
        pip install boto3
    - name: Submit Job (for Push)
      if: ${{ github.event_name == 'push' }}
      shell: bash
      run: |
        echo "Start submitting job - Push"  
        python3 ./submitJob.py --job-type CI-GPU-PUSH --name Graphstorm-E2E-MGPUTest-Push-'${{ github.ref }}' --command "${{ env.COMMAND-E2E-MGPU }}" --wait

# -----------------------------------------------
  # - name: Submit Job (for Pull Request)
  #   if: ${{ github.event_name == 'pull_request' }}
  #   shell: bash
  #   run: |
  #     echo "Start submitting job - Pull Request"
  #     python3 ./submitJob.py --job-type CI-CPU --name Graphstorm-LintCheck-PR#-'${{ github.event.number }}' --command "FORCE_CUDA=1 python3 -m pip install -e '.[test]'  --no-build-isolation && python3 -m pip install pytest && sh ./tests/unit-tests/prepare_test_data.sh && export NCCL_IB_DISABLE=1; export NCCL_SHM_DISABLE=1; NCCL_NET=Socket NCCL_DEBUG=INFO python3 -m pytest ./tests/unit-tests -s" --wait    

  #put pytest COMMAND here
  # pytest_check:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - name: Checkout repository
  #     uses: actions/checkout@v2
  #   - name: Check if changes beside docs
  #     uses: dorny/paths-filter@v2
  #     id: changes
  #     with:
  #       filters: |
  #         other_than_docs:
  #           - '!(docs/**)**'
  #   - name: Lint Check on AWS Batch
  #     if: steps.changes.outputs.other_than_docs == 'true'
  #     uses: ./.github/actions/submit-job
  #     with:
  #       job-type: CI-CPU
  #       job-name: Graphstorm-PyTest
  #       command: chmod +x ./pytest_check.sh && ./pytest_check.sh


    


